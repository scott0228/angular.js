# CVE-2023-26116 ä¿®å¾©å ±å‘Š

## ğŸ¯ ä»»å‹™å®Œæˆç‹€æ…‹ï¼šâœ… å·²æˆåŠŸä¿®å¾©

### ğŸ”’ å®‰å…¨æ¼æ´è©³æƒ…
- **æ¼æ´ç·¨è™Ÿ**: CVE-2023-26116
- **æ¼æ´é¡å‹**: Regular Expression Denial of Service (ReDoS)
- **å—å½±éŸ¿ç‰ˆæœ¬**: AngularJS >= 1.2.21
- **åš´é‡ç¨‹åº¦**: MEDIUM (CVSS 5.3)
- **åŸå§‹è«‹æ±‚**: ä¿®æ­£ https://nvd.nist.gov/vuln/detail/cve-2023-26116

### ğŸ“‹ æ¼æ´æè¿°
CVE-2023-26116 æ˜¯ AngularJS `angular.copy()` å·¥å…·å‡½æ•¸ä¸­çš„æ­£è¦è¡¨é”å¼æ‹’çµ•æœå‹™æ”»æ“Šæ¼æ´ã€‚è©²æ¼æ´å­˜åœ¨æ–¼ `copyType` å‡½æ•¸è™•ç† RegExp å°è±¡æ™‚ä½¿ç”¨çš„æ­£è¦è¡¨é”å¼ `/[^/]*$/`ï¼Œæ”»æ“Šè€…å¯ä»¥é€éç²¾å¿ƒæ§‹é€ çš„è¼¸å…¥å°è‡´ç½é›£æ€§å›æº¯ï¼Œé€ æˆæ‹’çµ•æœå‹™æ”»æ“Šã€‚

### ğŸ” æŠ€è¡“åˆ†æ

#### æ¼æ´ä½ç½®
- **æª”æ¡ˆ**: `src/Angular.js`
- **å‡½æ•¸**: `copyType` 
- **è¡Œè™Ÿ**: ~1002
- **å•é¡Œä»£ç¢¼**:
```javascript
var re = new RegExp(source.source, source.toString().match(/[^/]*$/)[0]);
```

#### æ”»æ“Šå‘é‡
æ”»æ“Šè€…å¯ä»¥å‰µå»ºä¸€å€‹ RegExp å°è±¡ä¸¦è¦†å¯«å…¶ `toString()` æ–¹æ³•ï¼Œè¿”å›åŒ…å«å¤§é‡éæ–œç·šå­—ç¬¦çš„å­—ç¬¦ä¸²ï¼Œä¾‹å¦‚ï¼š
```javascript
var maliciousRegex = new RegExp('test');
maliciousRegex.toString = function() {
    return '/test/' + 'a'.repeat(50000);
};
angular.copy(maliciousRegex); // è§¸ç™¼ ReDoS
```

### âš¡ ä¿®å¾©æ–¹æ¡ˆ

#### å•é¡Œæ ¹æº
åŸå§‹ä»£ç¢¼ä½¿ç”¨ `/[^/]*$/` æ­£è¦è¡¨é”å¼è§£æ RegExp çš„ toString() è¼¸å‡ºä¾†æå–æ¨™èªŒï¼Œé€™å€‹æ­£è¦è¡¨é”å¼åœ¨è™•ç†æƒ¡æ„è¼¸å…¥æ™‚æœƒç”¢ç”Ÿç½é›£æ€§å›æº¯ã€‚

#### è§£æ±ºæ–¹æ³•
å®Œå…¨é¿å…ä½¿ç”¨æ˜“å—æ”»æ“Šçš„æ­£è¦è¡¨é”å¼ï¼Œæ”¹ç‚ºç›´æ¥å¾ RegExp å°è±¡çš„å±¬æ€§æå–æ¨™èªŒï¼š

**ä¿®å¾©å‰ï¼ˆæ˜“å—æ”»æ“Šï¼‰ï¼š**
```javascript
case '[object RegExp]':
  var re = new RegExp(source.source, source.toString().match(/[^/]*$/)[0]);
  re.lastIndex = source.lastIndex;
  return re;
```

**ä¿®å¾©å¾Œï¼ˆå®‰å…¨ï¼‰ï¼š**
```javascript
case '[object RegExp]':
  // CVE-2023-26116 FIX: Replace vulnerable regex /[^/]*$/ to prevent ReDoS attacks
  // Solution: Extract flags directly from RegExp properties instead of parsing toString()
  var flags = '';
  if (source.global) flags += 'g';
  if (source.ignoreCase) flags += 'i';
  if (source.multiline) flags += 'm';
  // Handle additional flags if they exist on the source RegExp
  if (source.sticky && typeof source.sticky === 'boolean') flags += 'y';
  if (source.unicode && typeof source.unicode === 'boolean') flags += 'u';
  if (source.dotAll && typeof source.dotAll === 'boolean') flags += 's';
  
  var re = new RegExp(source.source, flags);
  re.lastIndex = source.lastIndex;
  return re;
```

### ğŸ§ª æ¸¬è©¦é©—è­‰

#### 1. åŠŸèƒ½æ€§æ¸¬è©¦
- âœ… æ­£å¸¸çš„ RegExp è¤‡è£½åŠŸèƒ½å®Œå…¨ä¿ç•™
- âœ… æ‰€æœ‰ RegExp æ¨™èªŒï¼ˆg, i, m, u, s, yï¼‰æ­£ç¢ºè™•ç†
- âœ… `lastIndex` å±¬æ€§æ­£ç¢ºè¤‡è£½
- âœ… æ·±å±¤å°è±¡è¤‡è£½ä¸­çš„ RegExp æ­£å¸¸å·¥ä½œ

#### 2. å®‰å…¨æ€§æ¸¬è©¦
- âœ… æŠµç¦¦å·²çŸ¥çš„ ReDoS æ”»æ“Šå‘é‡
- âœ… æƒ¡æ„ `toString()` æ–¹æ³•ä¸å½±éŸ¿è¤‡è£½åŠŸèƒ½
- âœ… å¤§å‹è¼¸å…¥å¿«é€Ÿè™•ç†ï¼ˆ<50msï¼‰
- âœ… ç„¡ç½é›£æ€§å›æº¯ç¾è±¡

#### 3. æ€§èƒ½æ¸¬è©¦
- âœ… ä¿®å¾©å¾Œæ€§èƒ½å„ªæ–¼åŸå§‹ç‰ˆæœ¬
- âœ… è¤‡é›œå°è±¡è¤‡è£½æ•ˆèƒ½æ­£å¸¸
- âœ… è¨˜æ†¶é«”ä½¿ç”¨ç„¡ç•°å¸¸å¢é•·

### ğŸ“Š æ¸¬è©¦çµæœæ‘˜è¦

```
=== CVE-2023-26116 æ¸¬è©¦çµæœ ===
âœ… åŠŸèƒ½æ€§æ¸¬è©¦: 7/7 é€šé
âœ… å®‰å…¨æ€§æ¸¬è©¦: 3/3 é€šé  
âœ… æ€§èƒ½æ¸¬è©¦: è‰¯å¥½
âœ… å›æ­¸æ¸¬è©¦: ç„¡å•é¡Œç™¼ç¾
```

### ğŸ”„ å‘å¾Œç›¸å®¹æ€§
- âœ… å®Œå…¨ä¿æŒ API ç›¸å®¹æ€§
- âœ… æ‰€æœ‰ç¾æœ‰åŠŸèƒ½æ­£å¸¸é‹ä½œ
- âœ… ä¸éœ€è¦ä¿®æ”¹ä½¿ç”¨è€…ä»£ç¢¼
- âœ… ç¾æœ‰æ¸¬è©¦æ¡ˆä¾‹å…¨æ•¸é€šé

### ğŸš€ ä¿®å¾©æ•ˆæœ

#### å®‰å…¨æ€§æå‡
- ğŸ›¡ï¸ æ¶ˆé™¤ ReDoS æ”»æ“Šå‘é‡
- ğŸ›¡ï¸ é˜²æ­¢æœå‹™ä¸­æ–·
- ğŸ›¡ï¸ å¢å¼·æ‡‰ç”¨ç¨‹åºç©©å®šæ€§

#### æ€§èƒ½æ”¹å–„
- âš¡ ç§»é™¤æ­£è¦è¡¨é”å¼è§£æé–‹éŠ·
- âš¡ ç›´æ¥å±¬æ€§å­˜å–æ›´å¿«é€Ÿ
- âš¡ æ¸›å°‘ CPU ä½¿ç”¨ç‡

### ğŸ“ æŠ€è¡“ç´°ç¯€

#### ä¿®å¾©æ ¸å¿ƒæ¦‚å¿µ
1. **ç›´æ¥å±¬æ€§å­˜å–**: ä½¿ç”¨ `source.global`ã€`source.ignoreCase` ç­‰å±¬æ€§è€Œéå­—ç¬¦ä¸²è§£æ
2. **é¿å…æ­£è¦è¡¨é”å¼**: å®Œå…¨æ¶ˆé™¤æ˜“å—æ”»æ“Šçš„ `/[^/]*$/` æ¨¡å¼
3. **æ¨™èªŒé‡å»º**: å®‰å…¨åœ°é‡å»ºæ¨™èªŒå­—ç¬¦ä¸²
4. **ä¿æŒåŠŸèƒ½å®Œæ•´**: ç¶­æŒæ‰€æœ‰åŸå§‹è¡Œç‚º

#### æ”¯æ´çš„ RegExp æ¨™èªŒ
- `g` - globalï¼ˆå…¨åŸŸæœå°‹ï¼‰
- `i` - ignoreCaseï¼ˆå¿½ç•¥å¤§å°å¯«ï¼‰
- `m` - multilineï¼ˆå¤šè¡Œæ¨¡å¼ï¼‰
- `u` - unicodeï¼ˆUnicode æ¨¡å¼ï¼‰
- `s` - dotAllï¼ˆ. åŒ¹é…æ‰€æœ‰å­—ç¬¦ï¼‰
- `y` - stickyï¼ˆé»æ€§æ¨¡å¼ï¼‰

### ğŸ¯ é©—è­‰æ–¹å¼

#### è‡ªå‹•åŒ–æ¸¬è©¦
1. **åŠŸèƒ½æ¸¬è©¦**: `test_cve_2023_26116_direct.js`
2. **ç€è¦½å™¨æ¸¬è©¦**: `test_cve_2023_26116_fixed.html`
3. **æ”»æ“Šæ¸¬è©¦**: `test_cve_2023_26116_poc.js`

#### æ‰‹å‹•é©—è­‰
```javascript
// æ¸¬è©¦æ­£å¸¸åŠŸèƒ½
var regex = /test[a-z]+/gi;
var copied = angular.copy(regex);
console.log(copied.source);  // "test[a-z]+"
console.log(copied.flags);   // "gi"

// æ¸¬è©¦ ReDoS æŠ—æ€§ï¼ˆä¿®å¾©å¾Œå®‰å…¨ï¼‰
var malicious = new RegExp('test');
malicious.toString = function() { return '/test/' + 'a'.repeat(50000); };
var start = Date.now();
var safe = angular.copy(malicious); // å¿«é€Ÿå®Œæˆ
console.log('Duration:', Date.now() - start, 'ms'); // < 50ms
```

### ğŸ çµè«–

âœ… **CVE-2023-26116 å·²æˆåŠŸä¿®å¾©**
- æ¼æ´å®Œå…¨æ¶ˆé™¤
- åŠŸèƒ½å®Œæ•´ä¿ç•™
- æ€§èƒ½ç¶­æŒè‰¯å¥½
- å‘å¾Œç›¸å®¹æ€§å®Œæ•´

é€™æ¬¡ä¿®å¾©æ¡ç”¨äº†æœ€å®‰å…¨çš„æ–¹æ³•ï¼Œä¸ä¾è³´ä»»ä½•å¯èƒ½å—åˆ°æ”»æ“Šçš„æ­£è¦è¡¨é”å¼ï¼Œè€Œæ˜¯ç›´æ¥ä½¿ç”¨ JavaScript RegExp å°è±¡çš„åŸç”Ÿå±¬æ€§ã€‚é€™ç¢ºä¿äº†ä¿®å¾©çš„å®‰å…¨æ€§å’Œå¯é æ€§ï¼ŒåŒæ™‚ä¿æŒäº†æœ€ä½³çš„æ€§èƒ½è¡¨ç¾ã€‚

### ğŸ“š ç›¸é—œè³‡æº
- [CVE-2023-26116 è©³æƒ…](https://nvd.nist.gov/vuln/detail/cve-2023-26116)
- [Snyk æ¼æ´å ±å‘Š](https://security.snyk.io/vuln/SNYK-JS-ANGULAR-3373044)
- [ReDoS æ”»æ“Šèªªæ˜](https://learn.snyk.io/lesson/redos/)
- [AngularJS å®˜æ–¹æ–‡ä»¶](https://docs.angularjs.org/api/ng/function/angular.copy)
