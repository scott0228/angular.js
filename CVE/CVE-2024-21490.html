<!DOCTYPE html>
<html>
  <head>
    <title>
      AngularJS vulnerability: `ng-srcset` parsing ReDoS
    </title>

    <meta name="author" content="XLTS.dev" />
    <meta
      name="description"
      content="A minimal reproduction of an AngularJS ReDoS vulnerability related to `ng-srcset` parsing."
    />

    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="../build/angular.js"></script>
    <script src="CVE-2024-21490.js"></script>
    <link rel="stylesheet" href="CVE-2023-26117.css" />
  </head>

  <body>
    <h1>
      <small>Reproduction of AngularJS vulnerability:</small><br />
      <code>ng-srcset</code> parsing ReDoS
    </h1>

    <section class="vulnerability-info-section">
      <h2>Vulnerability information</h2>
      <table class="vulnerability-info-table">
        <tr>
          <th>Type:</th>
          <td><a href="https://owasp.org/www-community/attacks/Regular_expression_Denial_of_Service_-_ReDoS">ReDoS</a></td>
        </tr>
        <tr>
          <th>Affected versions:</th>
          <td>>=v1.3.0</td>
        </tr>
        <tr>
          <th>Fixed in version:</th>
          <td><a href="https://xlts.dev/angularjs">XLTS for AngularJS</a> v1.9.3 and v1.5.19</td>
        </tr>
        <tr>
          <th>Description:</th>
          <td>
            A regular expression used to split the value of the <a href="https://docs.angularjs.org/api/ng/directive/ngSrcset"><code>ng-srcset</code></a> directive is vulnerable to super-linear runtime due to backtracking.
            With a large carefully-crafted input, this can result in catastrophic backtracking and cause a denial of service of the application, also known as a <a href="https://owasp.org/www-community/attacks/Regular_expression_Denial_of_Service_-_ReDoS">ReDoS attack</a>.
          </td>
        </tr>
      </table>
    </section>

    <section class="repro-instructions-section">
      <h2>Reproduction instructions</h2>
      <p>
        Note: reproduction steps should be run in Chrome or Safari due to differences in handling large strings between those two browsers or Firefox.
      </p>
      <p>
        The app below demonstrates the issue by filling an <code>&lt;img ng-srcset="..."&gt;</code> element with a user-provided string and then running AngularJS' compiler, triggering built-in <code>ng-srcset</code> parsing logic.
      </p>
      <p>
        Note that the test case doesn't insert interpolation markers (`{` or `}` symbols); stripping them out from user input before applying to `ng-srcset` does not avoid the issue.
      </p>
      <p>
        It is essentially the equivalent of:
        <pre>
          &lt;img ng-srcset="{{ $ctrl.userProvidedString }}">
        </pre>
      </p>
      <p>
        <b>Steps:</b>
        <ol>
          <li>
            Set the input value to a valid <code>ng-srcset</code> string containing many spaces.
          </li>
          <li>
            You can click one of the available buttons to set the string to a value with many spaces.
          </li>
          <li>
            Click the "Compile <code>ng-srcset</code>" button to update the test <code>img</code> element with a requested value of <code>ng-srcset</code>.<br />
            <blockquote>
              ðŸ“Œ <b>NOTICE:</b>
              <i>The tab will be unresponsive while the <code>img</code> is being recompiled. The more spaces in the <code>ng-srcset</code> string, the longer the tab will remain unresponsive.</i>
            </blockquote>
          </li>
          <li>
            Observe that the time it takes to update each <code>ng-srcset</code> value increases super-linearly relative to the string length.
          </li>
        </ol>
      </p>
    </section>

    <section class="repro-content-section" ng-app="app" ng-controller="AppCtrl as $ctrl">
      <h2>Reproduction</h2>
      <p>
        Compile <code>ng-srcset</code> to value with N spaces:<br />
        <button
            ng-repeat="n in [15, 16, 17, 18, 19, 20]"
            ng-click="$ctrl.setNgSrcSetWithSpacesPowerOf2Exponent(n)">
          2^{{ n }}
        </button>
      </p>
      <p>
        <label class="repro-label">
          <span><code>ng-srcset</code>:</span>
          <input
              class="repro-input"
              type="url"
              ng-model="$ctrl.ngSrcSet" />
          <span>(length: {{ $ctrl.ngSrcSet.length | number }})</span>
        </label>
      </p>
      <p>
        <button class="repro-btn" ng-click="$ctrl.compileNgSrcSet()">Compile <code>ng-srcset</code></button>
        <span class="repro-duration">Time to compile <code>ng-srcset</code>: <b>{{ $ctrl.duration }}</b></span>
      </p>
      <p ng-ref="$ctrl.ngSrcSetCompiledElem"></p>
    </section>
  </body>
</html>
