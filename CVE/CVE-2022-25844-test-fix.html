<!DOCTYPE html>
<html>
<head>
    <title>CVE-2022-25844 ReDoS Test - FIXED</title>
    <script src="../../build/angular.js"></script>
</head>
<body ng-app="testApp">
    <div ng-controller="TestController">
        <h1>CVE-2022-25844 ReDoS Test - FIXED Version</h1>
        <p>Amount: {{amount}}</p>
        <p>Currency (normal): {{amount | currency:'$':2}}</p>
        <p>Currency (empty symbol): {{amount | currency:'':2}}</p>
        <p>Test Status: {{testStatus}}</p>
        <p>Execution Time: {{executionTime}} ms</p>
        <button ng-click="runReDoSTest()">Run ReDoS Test</button>
        <button ng-click="runMaliciousTest()">Run Malicious Pattern Test</button>
    </div>

    <script>
        angular.module('testApp', [])
        .controller('TestController', ['$scope', '$filter', '$locale', function($scope, $filter, $locale) {
            $scope.amount = 100;
            $scope.testStatus = 'Ready';
            $scope.executionTime = 0;
            
            $scope.runReDoSTest = function() {
                var currency = $filter('currency');
                var startTime = Date.now();
                
                // This should not cause ReDoS anymore
                var result = currency($scope.amount, '', 2);
                
                var endTime = Date.now();
                $scope.executionTime = endTime - startTime;
                $scope.testStatus = $scope.executionTime < 100 ? 'PASSED - No ReDoS' : 'FAILED - Possible ReDoS';
            };
            
            $scope.runMaliciousTest = function() {
                var currency = $filter('currency');
                var originalPattern = $locale.NUMBER_FORMATS.PATTERNS[1];
                var originalPosPre = originalPattern.posPre;
                
                try {
                    // Create a malicious pattern with many spaces (but limited by our fix)
                    var manySpaces = Array(100).join(' '); // 99 spaces
                    originalPattern.posPre = manySpaces + '\u00A4' + manySpaces;
                    
                    var startTime = Date.now();
                    var result = currency($scope.amount, '', 2);
                    var endTime = Date.now();
                    
                    $scope.executionTime = endTime - startTime;
                    $scope.testStatus = $scope.executionTime < 100 ? 'PASSED - Fixed ReDoS' : 'FAILED - Still vulnerable';
                    
                } finally {
                    originalPattern.posPre = originalPosPre;
                }
            };
        }]);
    </script>
</body>
</html>
