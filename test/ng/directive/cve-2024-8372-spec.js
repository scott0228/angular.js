'use strict';

/* eslint-disable no-script-url,no-console,max-len */

describe('CVE-2024-8372: ngSrcset sanitization bypass', function() {
  var element, $rootScope, $compile, $sce, $compileProvider;

  beforeEach(function() {
    module('ng', function(_$compileProvider_) {
      $compileProvider = _$compileProvider_;
      // Configure to only allow images from specific domain (like the CVE demo)
      $compileProvider.imgSrcSanitizationTrustedUrlList(/^https:\/\/angularjs\.org\//);
    });
  });

  beforeEach(inject(function(_$rootScope_, _$compile_, _$sce_) {
    $rootScope = _$rootScope_;
    $compile = _$compile_;
    $sce = _$sce_;
  }));

  afterEach(function() {
    dealoc(element);
  });

  describe('Vulnerability demonstration', function() {
    it('should block untrusted domain in ngSrc (baseline - working correctly)', function() {
      $rootScope.imageUrl = 'https://angular.dev/favicon.ico';
      element = $compile('<img ng-src="{{imageUrl}}">')($rootScope);
      $rootScope.$digest();

      // ngSrc should properly block the untrusted domain
      expect(element.attr('src')).toBe('unsafe:https://angular.dev/favicon.ico');
    });

    it('should allow trusted domain in ngSrc (baseline - working correctly)', function() {
      $rootScope.imageUrl = 'https://angularjs.org/favicon.ico';
      element = $compile('<img ng-src="{{imageUrl}}">')($rootScope);
      $rootScope.$digest();

      // ngSrc should allow the trusted domain
      expect(element.attr('src')).toBe('https://angularjs.org/favicon.ico');
    });

    it('VULNERABILITY: should bypass sanitization with ngSrcset using comma-separated bypass', function() {
      // This is the vulnerability: ngSrcset doesn't properly parse srcset values
      // The bypass technique: "trusted_url invalid_descriptor,untrusted_url"
      // This should be blocked but currently isn't due to improper sanitization
      $rootScope.srcsetValue = 'https://angularjs.org/favicon.ico xyz,https://angular.dev/favicon.ico';
      element = $compile('<img ng-srcset="{{srcsetValue}}">')($rootScope);
      $rootScope.$digest();

      var srcsetAttr = element.attr('srcset');

      // The vulnerability: this should NOT contain the untrusted angular.dev domain
      // but it currently does because ngSrcset doesn't properly parse and sanitize each URL
      expect(srcsetAttr).toContain('angular.dev');

      // This test demonstrates the vulnerability exists
    });

    it('VULNERABILITY: should bypass sanitization with ngAttrSrcset', function() {
      $rootScope.srcsetValue = 'https://angularjs.org/favicon.ico xyz,https://angular.dev/favicon.ico';
      element = $compile('<img ng-attr-srcset="{{srcsetValue}}">')($rootScope);
      $rootScope.$digest();

      var srcsetAttr = element.attr('srcset');
      expect(srcsetAttr).toContain('angular.dev');
    });

    it('VULNERABILITY: should bypass sanitization with data URL in ngSrcset', function() {
      // Test with data URL bypass
      var dataUrl = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My';
      $rootScope.srcsetValue = 'https://angularjs.org/favicon.ico xyz,' + dataUrl;
      element = $compile('<img ng-srcset="{{srcsetValue}}">')($rootScope);
      $rootScope.$digest();

      var srcsetAttr = element.attr('srcset');
      expect(srcsetAttr).toContain('data:image/svg+xml');
    });
  });

  describe('Expected behavior after fix', function() {
    it('should properly sanitize each URL in srcset after fix', function() {
      // After the fix, this should properly sanitize each URL individually
      $rootScope.srcsetValue = 'https://angularjs.org/favicon.ico xyz,https://angular.dev/favicon.ico';
      element = $compile('<img ng-srcset="{{srcsetValue}}">')($rootScope);
      $rootScope.$digest();

      var srcsetAttr = element.attr('srcset');

      // After fix: should contain the trusted domain
      expect(srcsetAttr).toContain('angularjs.org');
      // After fix: untrusted domain should be marked as unsafe
      expect(srcsetAttr).toContain('unsafe:https://angular.dev/favicon.ico');
    });

    it('should properly sanitize ngAttrSrcset after fix', function() {
      $rootScope.srcsetValue = 'https://angularjs.org/favicon.ico xyz,https://angular.dev/favicon.ico';
      element = $compile('<img ng-attr-srcset="{{srcsetValue}}">')($rootScope);
      $rootScope.$digest();

      var srcsetAttr = element.attr('srcset');
      expect(srcsetAttr).toContain('angularjs.org');
      expect(srcsetAttr).toContain('unsafe:https://angular.dev/favicon.ico');
    });

    it('should properly sanitize data URLs in srcset after fix', function() {
      var dataUrl = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My';
      $rootScope.srcsetValue = 'https://angularjs.org/favicon.ico xyz,' + dataUrl;
      element = $compile('<img ng-srcset="{{srcsetValue}}">')($rootScope);
      $rootScope.$digest();

      var srcsetAttr = element.attr('srcset');
      expect(srcsetAttr).toContain('angularjs.org');
      expect(srcsetAttr).toContain('unsafe:data:image/svg+xml');
    });
  });
});
