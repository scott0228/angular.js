'use strict';

/* eslint-disable no-script-url */

describe('CVE-2024-8372: srcset attribute sanitization bypass fix', function() {
  var element, $rootScope, $compile;

  beforeEach(inject(function(_$rootScope_, _$compile_) {
    $rootScope = _$rootScope_;
    $compile = _$compile_;
  }));

  afterEach(function() {
    if (element) {
      dealoc(element);
      element = null;
    }
  });

  describe('ng-attr-srcset directive sanitization', function() {
    it('should sanitize malicious URLs in ng-attr-srcset', function() {
      $rootScope.maliciousUrl = 'javascript:alert("XSS") 1x, http://example.com/safe.jpg 2x';
      element = $compile('<img ng-attr-srcset="{{maliciousUrl}}">')($rootScope);
      $rootScope.$digest();

      var srcsetValue = element.attr('srcset');
      expect(srcsetValue).toContain('unsafe:javascript:alert("XSS")');
      expect(srcsetValue).toContain('http://example.com/safe.jpg');
    });

    it('should sanitize srcset on source elements via ng-attr-srcset', function() {
      $rootScope.maliciousUrl = 'javascript:alert("XSS") 480w, http://example.com/safe.jpg 800w';
      element = $compile('<source ng-attr-srcset="{{maliciousUrl}}">')($rootScope);
      $rootScope.$digest();

      var srcsetValue = element.attr('srcset');
      expect(srcsetValue).toContain('unsafe:javascript:alert("XSS")');
      expect(srcsetValue).toContain('http://example.com/safe.jpg');
    });

    it('should sanitize srcset on any element via ng-attr-srcset', function() {
      // Test on a div element to ensure sanitization works for any element
      $rootScope.maliciousUrl = 'javascript:alert("XSS") 1x';
      element = $compile('<div ng-attr-srcset="{{maliciousUrl}}">')($rootScope);
      $rootScope.$digest();

      var srcsetValue = element.attr('srcset');
      expect(srcsetValue).toContain('unsafe:javascript:alert("XSS")');
    });
  });

  describe('ng-prop-srcset directive sanitization', function() {
    it('should sanitize malicious URLs in ng-prop-srcset for any element', function() {
      $rootScope.maliciousUrl = 'javascript:alert("XSS") 1x';
      element = $compile('<div ng-prop-srcset="maliciousUrl">')($rootScope);
      $rootScope.$digest();

      var srcsetValue = element[0].srcset;
      expect(srcsetValue).toContain('unsafe:javascript:alert("XSS")');
    });

    it('should sanitize srcset property on custom elements', function() {
      $rootScope.maliciousUrl = 'javascript:alert("XSS") 1x, http://example.com/safe.jpg 2x';
      element = $compile('<custom-element ng-prop-srcset="maliciousUrl">')($rootScope);
      $rootScope.$digest();

      var srcsetValue = element[0].srcset;
      expect(srcsetValue).toContain('unsafe:javascript:alert("XSS")');
      expect(srcsetValue).toContain('http://example.com/safe.jpg');
    });
  });

  describe('direct srcset attribute sanitization', function() {
    it('should sanitize srcset attribute values for any element', function() {
      element = $compile('<div>')($rootScope);
      var attrs = element.data('$attrs') || element[0].attributes;

      // Simulate setting srcset attribute directly
      element.attr('srcset', 'javascript:alert("XSS") 1x');

      // The sanitization should happen when the attribute is processed
      var srcsetValue = element.attr('srcset');
      // Note: This test may behave differently depending on how attributes are processed
      expect(srcsetValue).toBeDefined();
    });
  });

  describe('nested interpolation scenarios', function() {
    it('should handle complex srcset expressions with multiple interpolations', function() {
      $rootScope.baseUrl = 'http://example.com';
      $rootScope.maliciousUrl = 'javascript:alert("XSS")';
      $rootScope.safeUrl = 'safe.jpg';

      element = $compile('<img ng-attr-srcset="{{baseUrl}}/{{safeUrl}} 1x, {{maliciousUrl}} 2x">')($rootScope);
      $rootScope.$digest();

      var srcsetValue = element.attr('srcset');
      expect(srcsetValue).toContain('http://example.com/safe.jpg');
      expect(srcsetValue).toContain('unsafe:javascript:alert("XSS")');
    });
  });

  describe('performance and ReDoS protection', function() {
    it('should not be vulnerable to ReDoS attacks', function() {
      // Create a potentially problematic srcset value
      var maliciousInput = 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 1x,' +
                          ' '.repeat(100) + ' 2x,' +
                          ' '.repeat(100) + ' 3x';

      $rootScope.srcsetValue = maliciousInput;

      var startTime = Date.now();
      element = $compile('<img ng-attr-srcset="{{srcsetValue}}">')($rootScope);
      $rootScope.$digest();
      var endTime = Date.now();

      // Should complete in reasonable time (not hang due to ReDoS)
      expect(endTime - startTime).toBeLessThan(1000);
      expect(element.attr('srcset')).toBeDefined();
    });
  });

  describe('edge cases and boundary conditions', function() {
    it('should handle empty srcset values', function() {
      $rootScope.emptyValue = '';
      element = $compile('<img ng-attr-srcset="{{emptyValue}}">')($rootScope);
      $rootScope.$digest();

      expect(element.attr('srcset')).toBe('');
    });

    it('should handle null srcset values', function() {
      $rootScope.nullValue = null;
      element = $compile('<img ng-attr-srcset="{{nullValue}}">')($rootScope);
      $rootScope.$digest();

      expect(element.attr('srcset')).toBeFalsy();
    });

    it('should handle undefined srcset values', function() {
      $rootScope.undefinedValue = undefined;
      element = $compile('<img ng-attr-srcset="{{undefinedValue}}">')($rootScope);
      $rootScope.$digest();

      expect(element.attr('srcset')).toBeUndefined();
    });
  });
});
