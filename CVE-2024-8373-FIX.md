# CVE-2024-8373 Security Fix for AngularJS

## 漏洞描述
CVE-2024-8373 是 AngularJS 中的一個安全漏洞，影響對 `<source>` 元素的 `srcset` 屬性的不當清理。攻擊者可以利用此漏洞繞過常見的圖像源限制，進而進行內容欺騙攻擊。

## 漏洞詳情
- **CVE ID**: CVE-2024-8373
- **CVSS 評分**: 4.3 MEDIUM (NIST) / 4.8 MEDIUM (HeroDevs)
- **影響版本**: 所有 AngularJS 版本（包括 1.8.3 及更早版本）
- **漏洞類型**: 不完整的特殊元素過濾 (CWE-791)

## 修正內容

### 1. 核心修正 (`src/ng/compile.js`)
修正了 `$set` 方法中對 srcset 屬性的清理邏輯：

**修正前：**
```javascript
// Sanitize img[srcset] values.
if (nodeName === 'img' && key === 'srcset') {
  this[key] = value = sanitizeSrcset(value, '$set(\'srcset\', value)');
}
```

**修正後：**
```javascript
// Sanitize img[srcset] + source[srcset] values.
if ((nodeName === 'img' || nodeName === 'source') && key === 'srcset') {
  this[key] = value = sanitizeSrcset(value, '$set(\'srcset\', value)');
}
```

### 2. 測試更新 (`test/ng/compileSpec.js`)

#### 新增測試案例：
1. 新增了對 `source[srcset]` 自動清理的測試
2. 新增了對 `source[srcset]` 不接受受信任值的測試

#### 測試基礎設施更新：
將 `source` 元素添加到測試指令的支援列表中：
```javascript
['input', 'a', 'img', 'source'].forEach(function(tag) { ... });
```

## 修正機制

1. **統一清理邏輯**: 現在 `img` 和 `source` 元素的 `srcset` 屬性都會使用相同的 `sanitizeSrcset` 函數進行清理。

2. **防護機制**: 
   - 自動清理惡意的 URL 方案（如 `javascript:`、`data:` 等）
   - 拒絕受信任的值，防止繞過清理機制
   - 保持正常的圖像 URL 不變

3. **向後兼容**: 修正不會破壞現有的正常功能，只是加強了安全性。

## 測試驗證

所有相關測試都已通過：
- ✅ 原有的 `img[srcset]` 測試繼續通過
- ✅ 新增的 `source[srcset]` 測試通過
- ✅ 整體測試套件通過

## 影響範圍

此修正影響以下場景：
1. 使用 `<source srcset="...">` 元素的應用程式
2. 透過 JavaScript 動態設置 `source` 元素 `srcset` 屬性的程式碼
3. 使用 AngularJS 指令動態綁定 `source` 元素 `srcset` 的應用程式

## 建議

1. **立即應用此修正**: 儘管 AngularJS 已停止支援，但此修正對於仍在使用 AngularJS 的專案很重要。

2. **安全審查**: 檢查應用程式中所有使用 `<source>` 元素和 `srcset` 屬性的地方。

3. **遷移計劃**: 考慮遷移到更新的 Angular 版本或其他現代前端框架。

## 相關資源

- [CVE-2024-8373 詳情](https://nvd.nist.gov/vuln/detail/CVE-2024-8373)
- [AngularJS 支援狀態](https://docs.angularjs.org/misc/version-support-status)
- [HeroDevs 漏洞目錄](https://www.herodevs.com/vulnerability-directory/cve-2024-8373)
