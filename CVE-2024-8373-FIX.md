# CVE-2024-8373 修復報告

## 漏洞概述

CVE-2024-8373 是 AngularJS 中的一個中等嚴重度漏洞，影響所有版本的 AngularJS。該漏洞允許攻擊者繞過圖片來源限制，這些限制通常應用於 `<source>` HTML 元素的 `[srcset]` 屬性值，進而導致內容欺騙（Content Spoofing）攻擊。

### 技術細節

**漏洞根因：**
- 當使用 `ng-attr-srcset` 指令或插值（如 `srcset="{{value}}"`）設置 `<source>` 元素的 `srcset` 屬性時，AngularJS 沒有對這些值進行圖片來源清理
- 這允許繞過應用程式中配置的圖片來源限制，可能導致內容欺騙

**受影響的用法：**
1. `<source ng-attr-srcset="{{maliciousUrl}}" />`
2. `<source srcset="{{maliciousUrl}}" />`

**不受影響的用法：**
- `ng-srcset` 指令正常工作並進行適當的清理
- `ng-prop-srcset` 指令正常工作並進行適當的清理

## 修復實施

### 修改的檔案
- `src/ng/compile.js`

### 修改內容

#### 1. 擴展 `getTrustedAttrContext` 函數

**位置：** `src/ng/compile.js` 第 3833 行

**修改前：**
```javascript
function getTrustedAttrContext(nodeName, attrNormalizedName) {
  if (attrNormalizedName === 'srcdoc') {
    return $sce.HTML;
  }
  // ... 其他邏輯
  } else if (attrNormalizedName === 'xlinkHref') {
```

**修改後：**
```javascript
function getTrustedAttrContext(nodeName, attrNormalizedName) {
  if (attrNormalizedName === 'srcdoc') {
    return $sce.HTML;
  }
  // ... 其他邏輯
  } else if (attrNormalizedName === 'srcset' || attrNormalizedName === 'ngSrcset') {
    // CVE-2024-8373: Ensure srcset attributes are properly sanitized for img and source elements
    if (nodeName === 'img' || nodeName === 'source') {
      return $sce.MEDIA_URL;
    }
  } else if (attrNormalizedName === 'xlinkHref') {
```

這個修改確保 `srcset` 和 `ngSrcset` 屬性在 `img` 和 `source` 元素上被標記為需要 `MEDIA_URL` 上下文，從而觸發適當的清理。

#### 2. 增強插值處理中的清理

**位置：** `src/ng/compile.js` `addAttrInterpolateDirective` 函數

**修改 1 - 初始化時的清理：**
```javascript
// initialize attr object so that it's ready in case we need the value for isolate
// scope initialization, otherwise the value would not be available from isolate
// directive's linking fn during linking phase
var initialValue = interpolateFn(scope);
// CVE-2024-8373: Apply additional sanitization for srcset attributes on img/source elements
if (name === 'srcset' && (nodeName === 'img' || nodeName === 'source')) {
  initialValue = sanitizeSrcset(initialValue, 'interpolation');
}
attr[name] = initialValue;
```

**修改 2 - 值變更時的清理：**
```javascript
$watch(interpolateFn, function interpolateFnWatchAction(newValue, oldValue) {
  //special case for class attribute addition + removal
  //so that class changes can tap into the animation
  //hooks provided by the $animate service. Be sure to
  //skip animations when the first digest occurs (when
  //both the new and the old values are the same) since
  //the CSS classes are the non-interpolated values
  if (name === 'class' && newValue !== oldValue) {
    attr.$updateClass(newValue, oldValue);
  } else {
    // CVE-2024-8373: Apply additional sanitization for srcset attributes on img/source elements
    if (name === 'srcset' && (nodeName === 'img' || nodeName === 'source')) {
      newValue = sanitizeSrcset(newValue, 'interpolation');
    }
    attr.$set(name, newValue);
  }
});
```

這些修改確保在插值處理期間，`srcset` 屬性的值在 `img` 和 `source` 元素上會經過 `sanitizeSrcset` 函數的額外清理。

## 安全影響

### 修復前的行為
- 使用 `ng-attr-srcset` 或插值的 `srcset` 值會繞過圖片來源限制
- 攻擊者可以載入來自不受信任域名的圖片
- 可能的內容欺騙攻擊

### 修復後的行為
- 所有 `srcset` 值（無論通過何種方式設置）都會經過適當的清理
- 不受信任的 URL 會被標記為 `unsafe:`
- 保持與現有 `ng-srcset` 指令的一致行為

## 測試覆蓋

修復包含了全面的測試套件（`test_cve_2024_8373_fix.js`），涵蓋：

1. **ng-attr-srcset 漏洞測試**
   - 驗證惡意 URL 被清理
   - 驗證受信任 URL 被允許
   - 測試複雜的 srcset 值（帶描述符）

2. **插值漏洞測試**
   - 驗證插值中的惡意 URL 被清理
   - 測試 data: URL 注入防護

3. **向後相容性測試**
   - 確保現有 `ng-srcset` 指令繼續正常工作
   - 驗證非 img/source 元素不受影響

## 向後相容性

此修復：
- ✅ 保持現有 API 不變
- ✅ 不破壞合法用例
- ✅ 與現有清理邏輯一致
- ✅ 遵循最小權限原則

## 部署建議

1. **立即部署**：這是一個安全修復，應該盡快部署
2. **測試應用程式**：驗證現有圖片來源限制配置仍然有效
3. **審查代碼**：檢查應用程式中是否有依賴舊行為的代碼

## 相關安全最佳實務

1. **配置圖片來源限制**：
   ```javascript
   $compileProvider.imgSrcSanitizationTrustedUrlList(/^https:\/\/trusted-domain\.com\//);
   ```

2. **使用 ng-srcset 指令**：優先使用內建的 `ng-srcset` 指令而不是 `ng-attr-srcset`

3. **定期安全審查**：定期檢查和更新安全配置

## 修復驗證

可以使用以下 PoC 驗證修復：

```html
<!-- 在修復前會繞過限制，修復後會被清理 -->
<picture>
  <source ng-attr-srcset="https://malicious.example.com/evil.jpg" />
  <img src="" />
</picture>

<!-- 同樣會被修復 -->
<picture>
  <source srcset="{{ 'https://malicious.example.com/evil.jpg' }}" />
  <img src="" />
</picture>
```

在修復後，這些 URL 會被標記為 `unsafe:https://malicious.example.com/evil.jpg`。
